# 沖ドキ！DUOアンコールシミュレーター - バージョン 2.3

このプロジェクトは、「スマスロ沖ドキ！DUOアンコール」パチスロ機の高精度シミュレーションを提供します。主に2つのコンポーネントで構成されています。

1.  **ウェブUIシミュレーター:** ブラウザでプレイできる、グラフィカルなインターフェースを持つインタラクティブなシミュレーターです。
2.  **ヘッドレスシミュレーター:** 大規模なシミュレーションを実行し、機械の出率（機械割）を検証するためのコマンドラインツールです。

このシミュレーションは、詳細なゲームモード、小役確率、および調査されたモード移行データを組み込むことにより、公式の出率を忠実に再現することを目指しています。

---

## 実行方法

### 1. インタラクティブなウェブUI

このモードでは、視覚的なインターフェースでゲームをブラウザでプレイできます。

**ステップ1: サーバーを起動**
ターミナルで以下のコマンドを実行してください。設定1から6までを指定できます。

```bash
# 設定6で起動
python3 server.py 6

# 設定1で起動（設定が指定されない場合のデフォルト）
python3 server.py
```

**ステップ2: ブラウザで開く**
ウェブブラウザで以下のURLを開いてください:
[http://localhost:8000](http://localhost:8000)

### 2. ヘッドレスシミュレーション（出率検証用）

このモードでは、指定されたゲーム数をバックグラウンドで実行し、出率を計算します。統計分析に役立ちます。

```bash
# 設定6で1,000,000ゲームをシミュレート
python3 simulation_runner.py --simulate 1000000 6

# 設定1で1,000,000ゲームをシミュレート（デフォルト）
python3 simulation_runner.py --simulate 1000000
```

---

## ウェブUIの機能

ウェブインターフェースは以下の機能を提供します:

### メイン表示部
*   **ゲームパネル:** 現在のモード、クレジット、ボーナスからのゲーム数、総ゲーム数を表示します。
*   **ハイビスカスランプ:** ボーナスが当たるとランプが明るく光ります。

### 操作部
*   **SPINボタン:** 1ゲームずつプレイします。
*   **SKIPボタン:** 次のボーナスが当たるまでゲームを自動で高速進行させます。
*   **Enterキー:** `SPIN`ボタンのショートカットとして機能します。

### データ可視化
*   **クレジット履歴チャート:** ゲーム中のクレジットの変動を表示する折れ線グラフです。X軸は総ゲーム数、Y軸はクレジット数を表します。
*   **ボーナス履歴テーブル:** 獲得した全てのボーナスの詳細なログです。各エントリには以下が含まれます:
    *   ボーナス種別（BIG / REG）
    *   ボーナス獲得時の総ゲーム数
    *   前回のボーナスからのゲーム数
    *   ボーナス後のゲームモード

---

## 技術ノート

### ❗ 重要: ロジックの同期

コアゲームロジック（確率、モード移行など）は、以下の2つのファイルで管理されています:

1.  `simulation_runner.py`（ヘッドレスシミュレーション用）
2.  `static/game.js`（ウェブUI用）

**ゲームメカニクスに変更を加える際は、両方のファイルに適用する**必要があります。これにより、2つのシミュレーターが同一の挙動を示すことを保証します。

### GitHubリポジトリ

このプロジェクトのソースコードはGitHubで管理されています。
*   **URL:** `https://github.com/Yuki-yamaguchi3847/okidoki-duo-simulator`

---

## シミュレーション仕様 (バージョン 2.3)

以下は、現在のシミュレーションで使用されている内部確率と仕様です。

### 払い出しとゲーム数

*   **1ゲームあたりのメダル投入枚数:** `3枚`
*   **ボーナスAT中の1ゲームあたりの純増:** `4.5枚`（総払い出し `7.5枚`）
*   **BIGボーナスATゲーム数:** `45G`（総純増 `202.5枚`）
*   **REGボーナスATゲーム数:** `18G`（総純増 `81枚`）

### 確率（全設定共通）

*   **中段チェリー:** `1 / 32768`
*   **リプレイ:** `1 / 7.3`（払い出し: `3枚`）
*   **ベル:** `1 / 12.2`（払い出し: `10枚`）
*   **スイカ:** `1 / 143.7`（払い出し: `5枚`）
*   **確定役:** `1 / 4369.1`（払い出しなし、ボーナス確定）

### 確率（設定別）

| Feature | 設定1 | 設定2 | 設定3 | 設定5 | 設定6 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **通常時ボーナス確率** | 1/240.0 | 1/230.2 | 1/215.8 | 1/192.1 | 1/181.0 |
| **チェリー** | 1/46.8 | 1/45.0 | 1/43.3 | 1/41.7 | 1/40.3 |

### ボーナスAT中の抽選

*   **「1G連」抽選:**
    *   チェリー時: `2%`で1G連獲得
    *   スイカ時: `6%`で1G連獲得

### 天国中のレア役によるモード昇格抽選

*   天国中のチェリー時: `5%`でドキドキモードへ昇格
*   天国中のスイカ時: `10%`でドキドキモードへ昇格、`1%`で超ドキドキモードへ昇格

### モード移行確率（ボーナスAT後 - 推定）

*   **中段チェリーボーナス後:**
    *   `55%` → 超ドキドキモード
    *   `40%` → ドキドキモード
    *   `5%` → 天国モード
*   **通常Aから:**
    *   `53%` → 通常A（ループ）
    *   `15%` → 通常B
    *   `32%` → 天国
*   **通常Bから:**
    *   `50%` → 通常B（ループ）
    *   `50%` → 天国
*   **チャンスモードから:**
    *   `40%` → 通常A
    *   `60%` → 天国
*   **天国から:**
    *   `75%` → 天国（ループ）
    *   `5%` → ドキドキ
    *   `10%` → 通常A
    *   `10%` → 通常B
    *   **天国突入時の昇格抽選:**（天国が選択された場合のみ）
        *   `0.5%` → 超ドキドキ
        *   `8%` → ドキドキ
*   **ドキドキから:**
    *   `78%` → ドキドキ（ループ）
    *   `20%` → 超ドキドキ
    *   `1%` → 通常A
    *   `1%` → 通常B
*   **超ドキドキから:**
    *   `94%` → 超ドキドキ（ループ）
    *   `6%` → 通常A

### 天井仕様

*   **ゲーム数天井:** ボーナス間 `800ゲーム`でボーナスが保証されます。
*   **スルー回数天井:** ボーナスが10回連続で天国モードへ移行しなかった場合、次のボーナスは天国モードへの優遇された移行抽選が行われます。
*   **天国モードからの強制転落:** 天国モード中に `32ゲーム`以内にボーナスが当選しなかった場合、モードは強制的に**通常A**へ変更されます。

---

## 開発状況と既知の問題 (2026-01-05現在)

*   **出率の不一致:** 現在のヘッドレスシミュレーター (`simulation_runner.py`) は、期待される出率よりも大幅に低い出率（例: 設定6で約87%）を算出します。これは、コード内で仮のボーナス確率パラメータが使用されているためです。これらのパラメータを公式の機械仕様に合わせるように修正することが、次なる開発の優先事項です。
